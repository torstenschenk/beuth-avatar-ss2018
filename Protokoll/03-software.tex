\section{Software Helfer}
Kurze Beschreibung der Software Hilfsprogramme

\subsection{Paket Manager}
Pakete auf aktuellem Stand halten
\begin{verbatim}
  sudo apt update
  sudo apt upgrade
  sudp apt-get update

  z.B. Firefox für Raspi instalieren
  sudo apt install firefox-esr
\end{verbatim}

\subsection{Video Formate der Kameras}
Wenn ein nicht unterstütztes Video Format angegeben wird bricht gstreamer ab und zeigt den Fehler
\begin{verbatim}
v4l2src0: Internal data stream error.
\end{verbatim}

Vor Auswahl eines Bildformates alle unterstützten Formate 
abfragen:
\begin{verbatim}
v4l2-ctl --list-formats-ext
\end{verbatim}

oder über USB Geräte die Kennung und danach all Höhen und Breiten abfragen.
\begin{verbatim}
lsusb
> Bus 001 Device 016: ID 046d:082d Logitech, Inc. HD Pro Webcam C920
lsusb -s 001:016 -v | egrep "Width|Height"
\end{verbatim}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Motion Installation \& Test}

Motion ist ein Programm, das in der Lage ist zu erkennen, wenn ein signifikanter Teil des Kamerabildes sich verändert. Es kann also Bewegung erkennen und einen Warnton übertragen. Kamera streaming Service welches verwendet werden kann, um den Videostream einer Webcam an eine IP Adresse zu leiten. Motion kann mit vielen Geräten verwendet werden. Unterstützt werden: V4L2 Webcams (closed source), Video Frame Grabber, Network Kameras via HTTP, RTSP, RTMP, PI Kameramodul, Webcam.\\

Video Stream zur IP Adresse des Devices (Raspi) im es im lokalen 
Netzwerk um Browser anzuzeigen....TODO

OP: Raspian\\
Setup: Streaming server motion\\

Anleitung nach Tutorial mit Anpassungen:\\
https://pimylifeup.com/raspberry-pi-webcam-server/\\

\textbf{Jessie and Strech are two debian major release}\\
Debian 9 (stretch) — current stable release\\
Debian 8 (jessie) — obsolete stable release\\

\textbf{Raspian pi\_strech\_motion}

\begin{enumerate}
	\item install:
	\begin{verbatim}
	sudo apt-get install libmariadbclient18 libpq5 libavcodec57  libavformat57
	    libavutil55 libswscale4
	\end{verbatim}
	einige Pakete sind outdated und müssen durch aktuelle ersetzt werden:
	\begin{verbatim}	
	sudo apt install libx264-148 libavcodec57 libavformat57 libmariadbclient-dev-compat 	
	    default-libmysqlclient-dev libswscale
	\end{verbatim}
	\item download motion stretch deb
	\begin{verbatim}
	sudo wget https://github.com/Motion-Project/motion/releases/download/release-4.0.1/pi
	_stretch_motion_4.0.1-1_armhf.deb
	sudo dpkg -i pi_stretch_motion_4.0.1-1_armhf.deb
	\end{verbatim}
	Motion konfigurieren
	\begin{verbatim}	
	sudo vim /etc/motion/motion.conf
	daemon on
	stream_localhost off
	if problems with freezing if motion occures
	output_pictures off
	ffmpeg_output_movies off
	optional
	stream_maxrate 100
	framerate 100
	width 640
	height 480
	\end{verbatim}
	
	\item setup daemon
	\begin{verbatim}
	sudo vim /etc/default/motion
	start_motion_daemon=yes
	\end{verbatim}
\end{enumerate}

\textbf{Start \& Stopp Motion und Streaming}
\begin{verbatim}
sudo service motion start
sudo service motion stop
\end{verbatim}
Browser zur Anzeige im lokalen Netzwerk (Ip Adresse des Raspberry)\\
192.168.1.xxx:8081

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{ffmpeg, ffserver, ffplay}
\textbf{ffmpeg mit alsa auf Raspberry }

Um Audio mit ffmpeg zu verwenden, wird häufig \textbf{alsa} verwendet. Die ffmpeg Pakete vom APT-Paketmanager (arm-hf) enthalten keinen Support für alsa, d.h. sie wurden nicht mit der Abhängigkeit zu alsa kompiliert.
   
REWORK in GERMAN:\\
No, unfortunately not. You must recompile ffmpeg to add enable additional libraries. Below is the script I build to compile ffmpeg with alsa, fdk-aac, and libx264 support. It will install ffmpeg in your home folder inside a "ffmpeg" folder, so you'll need to call it specifically from there unless you add it to your path. I recommend uninstalling your current ffmpeg before using my script.

Btw, I am able to stream directly to YouTube now without any issues. I use an external USB sound card and the PiCam v2 and stream a 1920x1080@25fps video stream with a 192kbps stereo audio stream mixed in. It works great!

\textbf{Installation von FFmpeg aus Source-Code}
Wichtige Info: ffserver wurde beim Upgrade auf ffmpeg Version 4.0 gelöscht. Letzte Version mit ffserver ist 3.4. Daher git checkout 3.4! Wenn ffplay mitkompiliert werden soll muss zuerst sdl installiert werden:
\begin{verbatim}
  sudo apt install libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev \
  libsdl2-mixer-dev
\end{verbatim}

Für libmp3lame > 3.88 bitte zusätzlich installieren:
\begin{verbatim}
  sudo apt install libmp3lame-dev
\end{verbatim}

Siehe auch:\\
http://computingvoyage.com/2114/installing-sdl2-on-raspbian-jessie/
\begin{verbatim}
#!/bin/bash
# ffmpeg install script by Schenk/Omid
# To make executable: chmod +x install.sh
# To install ffserver, you have to check out the 3.5 of 3.4 version of ffmepg git 
# repo to be able to compile ffmpeg with x264, you also have to choose an old 
# version from git repo tested was the version, before x264_bit_depth was removed 
# (needed for ffmpeg 3.4, 3.5)
# x264 hash key checkout: 7839a9e1f03b49e3e0cbfcb3091093af7c6d54ee
#
wget http://downloads.xiph.org/releases/vorbis/libvorbis-1.3.3.tar.gz
tar -xf libvorbis-1.3.3.tar.gz
cd libvorbis-1.3.3/
./configure --host=arm-unknown-linux-gnueabi --enable-static
make
sudo make install
cd ..
# libogg
wget http://downloads.xiph.org/releases/ogg/libogg-1.3.1.tar.gz
tar -xf libogg-1.3.1.tar.gz
cd libogg-1.3.1/
./configure --host=arm-unknown-linux-gnueabi --enable-static
make
sudo make install
cd ..
# libtheora
wget http://downloads.xiph.org/releases/theora/libtheora-1.1.1.tar.bz2
tar -xf libtheora-1.1.1.tar.bz2
cd libtheora-1.1.1/
./configure --host=arm-unknown-linux-gnueabi --enable-static
make
sudo make install
cd ..
git clone http://git.videolan.org/git/x264.git
cd x264
./configure --host=arm-unknown-linux-gnueabi --enable-static --disable-opencl
echo "Compiling x264"
make
sudo make install
cd ..
# extra alsa
wget ftp://ftp.alsa-project.org/pub/lib/alsa-lib-1.1.1.tar.bz2
tar xjf alsa-lib-1.1.1.tar.bz2
cd alsa-lib-1.1.1/
./configure --host=arm-unknown-linux-gnueabi --enable-static
make -j4
sudo make install
cd ..
# libvpx
git clone https://chromium.googlesource.com/webm/libvpx
cd libvpx
./configure --enable-static
make -j4
sudo make install
cd ..
# libsdl
wget http://www.libsdl.org/release/SDL-1.2.15.tar.gz
tar xzvf SDL-1.2.15.tar.gz
cd SDL-1.2.15
./configure --host=arm-unknown-linux-gnueabi --enable-static
make -j4
sudo make install
cd ..
git clone https://github.com/FFmpeg/FFmpeg.git
cd ffmpeg
./configure --arch=armel --target-os=linux --enable-gpl --enable-libx264 \
  --enable-nonfree --enable-libtheora --enable-libvorbis --enable-libvpx \
  --enable-libmp3lame
make
sudo make install
\end{verbatim}	
HINT: nachdem ./configure ausgeführt wurde, kann im Log kontrolliert werden, ob alle 
benötigten apps kompiliert werden. Es sollten die Bibliotheken, alsa, libx264, sdl2,
libtheora, libxcb, libvpx und die Programme ffmpeg, ffserver und \textbf{ffplay} 
angezeigt werden.
\begin{verbatim}
External libraries:
alsa			libvorbis		libxcb_shape		sndio
iconv			libvpx			libxcb_xfixes		xlib
libmp3lame		libx264			sdl2			zlib
libtheora		libxcb

External libraries providing hardware acceleration:
v4l2_m2m

Libraries:
avcodec			avfilter		avutil			swresample
avdevice		avformat		postproc		swscale

Programs:
ffmpeg			ffplay			ffprobe			ffserver
\end{verbatim}

\subsection{ffmepg Optionen \& Flags}
Auswahl nicht Codec abhängiger Parameter mit moderner Schreibweise. Viele Tutorials enthalten das -an oder -av Flag zum temporären abschalten von Audio oder Video!
\begin{verbatim}
-formats   print the list of supported file formats
-codecs    print the list of supported codecs (E=encode,D=decode)
-i         set the input file. Multiple -i switchs can be used
-f         set video format (for the input if before of -i, for output otherwise)
-an        *** ignore audio
-vn        *** ignore video
-ar /-r    set audio rate (in Hz), -r also working
-ac        set the number of channels
-b:a /-ab  set audio bitrate
-b:v /-b   Video bitrate
-bt        Video bitrate tolerance
-c:a /-acodec  choose audio codec or use “copy” to bypass audio encoding
-c:v /-vcodec  choose video codec or use “copy” to bypass video encoding
-r         video fps. You can also use fractional values like 30000/1001 instead of 29.97
-s         frame size (w x h, ie: 320x240)
-aspect    set the aspect ratio i.e: 4:3 or 16:9
-sameq     ffmpeg tries to keep the visual quality of the input
-t N       encode only N seconds of video (you can use also the hh:mm:ss.ddd format)
-croptop, -cropleft, -cropright, -cropbottom   crop input video frame on each side
-y         automatic overwrite of the output file
-ss        select the starting time in the source file
-vol       change the volume of the audio
-g         Gop size (distance between keyframes)
-metadata  add a key=value metadata
\end{verbatim}

\subsection{ffmepg Tests}
Als erster Test kann ffmpeg dazu verwendet werden Videos mit oder ohne Audio zu speichern.\\
Dabei traten beim .ogg Format ungewöhnliche Speed-Ups oder Sprünge statt. Mp4 ist von 
ausgezeichneter Qualität. Der Befehl list\_formats zeigt alle von der Webcam unterstützten 
Formate an.\\

Die niedrigste Latenz kann mittels Flags für die Anzeige Apps erreicht werden:
\begin{verbatim}
  ffplay -fflags nobuffer 
  mplayer -benchmark
\end{verbatim}

Test nur Video:
\begin{verbatim}
  ffmpeg -f v4l2 -list_formats all -i /dev/video0

  ffmpeg -f v4l2 -r 25 -s 640x480 -i /dev/video0 out.avi
  ffmpeg -f v4l2 -r 25 -s 640x480 -i /dev/video0 out.mp4
  ffmpeg -f v4l2 -r 25 -s 640x480 -i /dev/video0 out.ogg
  ffplay out...
\end{verbatim}

Test nur Audio:
\begin{verbatim}
  arecord -D plughw:1,0 -f cd test.wav
  mplayer test.wav
  ffmpeg -f alsa -i hw:1 -t 30 out.wav
  ffplay out.wav
\end{verbatim}

Test mit Video und Audio (audio delay 1s):
\begin{verbatim}
  ffmpeg -f alsa -ar 24000 -i plughw:1 -f v4l2 -r 20 -i /dev/video0 \
  -vcodec mpeg4 -acodec aac -strict experimental out.mp4
  ffplay out.mp4
  Test mit Video und Audio (audio delay 1s):
\end{verbatim}
Test mit Video und Audio (audio delay 0.3s):
\begin{verbatim}
  ffmpeg -f alsa -r 48000 -i hw:1 -f v4l2 -s 800x600 -i /dev/video0 \
  -r 45 -f avi -c:v mpeg4 -vtag xvid -c:a libmp3lame -b:a 96k output.avi
\end{verbatim}

\subsection{Streaming Audio \& Video}
Live-Stream to YouTube (YouTube Account nötig):
\begin{verbatim}
  ffmpeg -f v4l2 -i /dev/video0 -ar 44100 -ac 2 -acodec pcm_s16le -f alsa -ac 2 \
  -i plughw:1 -acodec aac -ab 128k -strict experimental -s 640x320 \
  -vcodec h264 -pix_fmt yuv420p -g 10 -vb 32k -profile:v baseline -r 5 \ 
  -f flv rtmp://a.rtmp.youtube.com/live2/<stream-key>
\end{verbatim}

Danach kann über den ffserver auf eine Webpage gestreamt werden:\\
ffserver.config
\begin{verbatim}
HTTPPort 9090
HTTPBindAddress 0.0.0.0
MaxHTTPConnections 2000
MaxClients 1000
MaxBandwidth 100000
#NoDaemon

<Feed feed1.ffm>
        File /tmp/feed1.ffm
        FileMaxSize 200K
        ACL allow 127.0.0.1
</Feed>

<Stream test.ogg>
        Format ogg
        Feed feed1.ffm

        VideoCodec libtheora
        VideoFrameRate 24
        VideoBitRate 512
        VideoSize 320x240
        VideoQMin 1
        VideoQMax 31
        VideoGopSize 12
        PreRoll 0
        AVOptionVideo flags +global_header
        Noaudio
</Stream>

<Stream stat.html>
        Format status
        # Only allow local people to get the status
        ACL allow localhost
        ACL allow 192.168.0.0 192.168.255.255
</Stream>                         
\end{verbatim}

Start ffserver und ffmpeg:
\begin{verbatim}
  ffserver -f ffserver.config
  ffmpeg -f v4l2 -i /dev/video0 -vcodec libtheora http://localhost:9090/feed1.ffm
\end{verbatim}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



